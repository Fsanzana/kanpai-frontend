<!DOCTYPE html>
<html>
  <head >
    <script src=
"https://code.jquery.com/jquery-3.5.1.js"></script>
    <link
      rel="icon"
      type="image/x-icon"
      href="../../../../assets/favicon.png"
    />

    <style>
      body {
        background-color: #303030;
        margin: 0px;
        padding: 0px;
      }

      .impress-enabled .step {
        transition: opacity 0.5s;
        opacity: 0;
      }

      .impress-enabled .step.active {
        opacity: 1;
      }

      .impress-enabled div#impress-toolbar {
        width: 100%;
        height: 100%;
        opacity: 0.6;
      }

      #impress-navigation-ui-prev {
        position: absolute;
        margin-left: 10px;
        top: 50%;
        left: 0px;

        border-radius: 2rem;
        background-color: #b63333;
        border: none;
        color: transparent;
        padding: 0.2rem 0.8rem;

        background-image: url("../../../../assets/arrow_left.png");
        background-position: center;
        background-size: contain;

        cursor: pointer;
        font-size: 2rem;
      }

      #impress-navigation-ui-next {
        position: absolute;
        margin-right: 10px;
        top: 50%;
        right: 0px;

        border-radius: 2rem;
        background-color: #b63333;
        border: none;
        color: transparent;
        padding: 0.2rem 0.8rem;

        background-image: url("../../../../assets/arrow_right.png");
        background-position: center;
        background-size: contain;

        cursor: pointer;
        font-size: 2rem;
      }

      #impress-navigation-ui-prev:hover {
        background-color: #ffffff;
      }

      #impress-navigation-ui-next:hover {
        background-color: #ffffff;
      }

      #impress-navigation-ui-prev:active {
        background-color: #cacaca;
      }

      #impress-navigation-ui-next:active {
        background-color: #cacaca;
      }

      #impress-navigation-ui-select {
        display: none;
      }

      #impress-autoplay-playpause {
        display: none;
      }

      #overviewSwitch {
        position: absolute;
        margin-left: 10px;
        margin-bottom: 10px;
        left: 0px;
        bottom: 0px;

        border-radius: 2rem;
        background-color: #b63333;
        border: none;
        color: #303030;
        padding: 0.35rem 0.5rem;

        background-position: center;
        background-size: contain;

        cursor: pointer;
      }

      #pageInput {
        position: absolute;
        margin-left: 10px;
        margin-bottom: 10px;
        bottom:0px;
        right: 0px;

        border-radius: 2rem;
        background-color: #b63333;
        border: none;
        padding: 0.4rem 0.4rem;
        width: 3.5rem;

        background-position: center;
        background-size: contain;

        cursor: pointer;
        font-size: 1rem;
      }

      #overviewSwitch:hover {
        background-color: #ffffff;
      }

      #overviewSwitch:active {
        background-color: #cacaca;
      }
    </style>
  </head>

  <script type="text/javascript">
    var swtichBoolean = false;
    var steps = [];
    //SET CURRENT PAGE
    var currentPage= 0;
    //SET CURRENT PAGE
    var currentStep=1;

    function loadManga(){

      loadPage();

      document.getElementById("impress-navigation-ui-next").onclick =
        nextPageJump;

      document.getElementById("impress-navigation-ui-prev").onclick =
        prevPageJump;
      
    }

    function loadPage(){
      $(document).ready(function () {
  
        $.getJSON("data.json", 
            function (data) {
              var panels = '';

              $.each(data, function (key, value) {
                steps[key]=(value.panels.length-1);
                if(parseInt(value.page)===parseInt(currentPage)){
          for (var i = 0; i <value.panels.length; i++) {
           if (value.panels[i].id==='overview'){
             panels+='<div id="overview" class="step active" data-x="0" data-y="0" data-z="0"><img src="'+
              value.panels[i].src+'"/></div>';
           } else {
                panels += '<div id="' + 
                value.panels[i].id+ '" class="step future" data-x="'+
                value.panels[i].dataX + '" data-y="'+
                value.panels[i].dataY + '" data-z="';
                panels+=value.panels[i].id.split('-').pop();
                panels+=  '" data-scale="'+
                value.panels[i].dataScale +'"><div id="'+
                value.panels[i].id +'-child" style="width: '+
                value.panels[i].width + 'px;height: '+
                value.panels[i].height + 'px; border: 3000px solid #303030; opacity: 0.99;"></div></div>';
              
            } 
          }
          }
          });
          document.getElementById("impress").innerHTML=panels;
          });
        });
    }   

    function overviewSwitch() {
      if (window.location.href.split("/").pop().split("-").pop() === "overview") {
        if (steps[currentPage] != 0) {
          document.getElementById("overviewIcon").src="../../../../assets/overview.png";
          location.assign("reader.html#/step-"+currentStep);
        } else {
          document.getElementById("overviewIcon").src="../../../../assets/unable.png";
        }
      } else {
        currentStep=parseInt(window.location.href.split("/").pop().split("-").pop());
        document.getElementById("overviewIcon").src="../../../../assets/panel.png";
        location.assign("reader.html#/overview");
      }
    }

    function onlyNumberKey(evt) {
              
              // Only ASCII character in that range allowed
              var ASCIICode = (evt.which) ? evt.which : evt.keyCode
              if (ASCIICode > 31 && (ASCIICode < 48 || ASCIICode > 57))
                  return false;
              return true;
          }

    function nextPageJump() {

      if (
        steps[currentPage] ===
          parseInt(window.location.href.split("/").pop().split("-").pop()) ||
        window.location.href.split("/").pop().split("-").pop() === "overview"
      ) {

        if (currentPage+1 < steps.length) {
          currentPage++;
          
          if ((steps[currentPage]) === 0){
            location.assign("reader.html#/overview");
          }else {
            currentStep=1;
            if (!window.location.href.split("/").pop() === "overview"){
              location.assign("reader.html#/step-1");
            }
          }

          loadPage();
        } else {
          console.log("LOAD NEXT CHAPTER");
          //LOAD NEXT CHAPTER
        }
        
      }
    }

    function prevPageJump() {
      if (
        1 ===
          parseInt(window.location.href.split("/").pop().split("-").pop()) ||
        window.location.href.split("/").pop().split("-").pop() === "overview"
      ) {

        if (currentPage-1 >= 0) {
          currentPage--;
          
          if ((steps[currentPage]) === 0){
            location.assign("reader.html#/overview");
          }else {
            if (!window.location.href.split("/").pop() === "overview"){
              currentStep=steps[currentPage];
              location.assign("reader.html#/step-"+steps[currentPage]);
            }
          }

          loadPage();
        } else {
          console.log("LOAD PREV CHAPTER");
          //LOAD NEXT CHAPTER
        }

      }
    }

    function docReady(fn) {
      // see if DOM is already available
      if (
        document.readyState === "complete" ||
        document.readyState === "interactive"
      ) {
        // call on next available tick
        setTimeout(fn, 1);
      } else {
        document.addEventListener("DOMContentLoaded", fn);
      }
    }

    //PUT THE SOMEWHAY THAT WILL UPTDATE THE IMPRESS TO LOAD PAGE

    function updateDiv(){ 
    $( "#here" ).load(window.location.href + " #here" );
  }

  function updateImpress(){
      $('#impress').load('#impress > *')
    }

  //PUT THE SOMEWHAY THAT WILL UPTDATE THE IMPRESS TO LOAD PAGE

    docReady(function () {
      function callback(mutationsList) {
        mutationsList.forEach((mutation) => {
          if (mutation.attributeName === "class") {
            if (
              document.getElementById("overview").classList.contains("past")
            ) {
              document.getElementById("overview").classList.remove("past");
              document.getElementById("overview").classList.add("active");
            }

            if (
              document.getElementById("overview").classList.contains("present")
            ) {
              document.getElementById("impress").style.zIndex = 1;
              document.getElementById("impress-toolbar").style.zIndex = 0;

              for (var i = steps[currentPage]; i >= 0; i--) {
                if (document.getElementById("step-" + i)) {
                  document.getElementById("step-" + i + "-child").style.border =
                    "0px";
                }
              }
            } else {
              document.getElementById("impress").style.zIndex = 0;
              document.getElementById("impress-toolbar").style.zIndex = 1;

              for (var i = steps[currentPage]; i >= 0; i--) {
                if (document.getElementById("step-" + i)) {
                  document.getElementById("step-" + i + "-child").style.border =
                    "3000px solid #303030";
                }
              }
            }
          }
        });
      }

      const mutationObserver = new MutationObserver(callback);

      mutationObserver.observe(document.getElementById("overview"), {
        attributes: true,
      });
    });
  </script>

  <body onload="loadManga()">
    <div id="impress-toolbar" style="position: absolute; z-index: 1">
      <button id="overviewSwitch" onclick="overviewSwitch()" title="Switch view">
        <img
          id="overviewIcon"
          src="../../../../assets/overview.png"
          height="30rem"
        />
      </button>
        <input id="pageInput" type="text" 
                   onkeypress="return onlyNumberKey(event)" 
                   maxlength="3"
                   value="0"
                   title="Choose page">
                   <b>/0</b>
    </div>

    <div id="impress" data-transition-duration="250" style="z-index: 0">
      <!-- TESTO MEME -->

      <!-- END TESTO MEME -->
      <script src="../../../js/impress.js"></script>
      <script>
        impress().init();
      </script>
  </body>
</html>
